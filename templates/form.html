<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="/static/css/general.css" rel="stylesheet" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/resumable.js/1.1.0/resumable.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" integrity="sha512-jnSuA4Ss2PkkikSOLtYs8BlYIeeIK1h99ty4YfvRPAlzr377vr3CXDb7sb7eEEBYjDtcYj+AjBH3FLv5uSJuXg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js" integrity="sha512-7Pi/otdlbbCR+LnW+F7PwFcSDJOuUJB3OxtEHbg4vSMvzvJjde4Po1v4BR9Gdc9aXNUNFVUY+SK51wWT8WF0Gg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.0/spark-md5.min.js"></script>
    <title>Upload data</title>
</head>
<body>
  <div class="app-navbar">
    <a href="https://spun.earth" class="logo"></a>
    <div class="menu">
      <ul>
        <li><a href="https://spun.earth">Spun Website</a></li>
        <li><a href="/">App homepage</a></li>
        <li><a href="/logout">Logout</a></li>
      </ul>
    </div>
  </div>
  <div class="content" style="p-4">
    <h1> Sequencing Files Submission Form </h1>
    <div id="msg" class="text-info">{{ msg }}</div>
    <div>
      <span id="process_id_info">Process id: {{ process_id }}</span> -
      <span id="upload_folder_info">Folder: {{ uploads_folder }}</span>
    </div>

    <div id="form_reporting">
      {% if form_reporting %}
        {% for data in form_reporting %}
          <div class="text-info">{{ data }}</div>
        {% endfor %}
      {% endif %}
    </div>

    <div id="step_1" class="form-step-item">
      <h3> Step 1: upload your metadata file</h3>
      <div class="text-danger">
        Please note: This is NOT the csv file that you created in order to describe your files.
        This is the metadata file you were originally asked to prepare for your samples.
      </div>
      {% if metadata_uploaded %}
        <div id="step_1_msg" class="text-success">Metadata file already uploaded : <a href="/download_metadata?process_id={{ process_id }}">{{ metadata_filename }}</a></div>
      {% else %}

        <form
            method="POST"
            action="/uploadmetadata"
            enctype="multipart/form-data"
            id="step_1_form"
        >
        <input type="file" id="step_1_button" accept=".csv">
        </form>
        <div id="step_1_msg"></div>
      {% endif %}
    </div>

    <div id="step_2" {% if not metadata_uploaded %} style="opacity: 0.5;" {% endif %} class="form-step-item">
      <h3> Step 2: Choose sequencing platform used </h3>
      {% if sequencing_method %}
        <div id="step_2_msg" class="text-success">
          Chosen sequencing platform:
          {% if sequencing_method == 1 %}
            Illumina
          {% elif sequencing_method == 2 %}
            Nanopore
          {% elif sequencing_method == 3 %}
            Pacific Biosciences
          {% elif sequencing_method == 4 %}
            Other (ION Torrent)
          {% endif %}
        </div>
      {% else %}
        <form id="step_2_form">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sequencing_method" id="sequencing_method_1" value="1">
            <label class="form-check-label" for="sequencing_method_1">
              Illumina
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sequencing_method" id="sequencing_method_2" value="2">
            <label class="form-check-label" for="sequencing_method_2">
              Nanopore
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sequencing_method" id="sequencing_method_3" value="3">
            <label class="form-check-label" for="sequencing_method_3">
              Pacific Biosciences
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="sequencing_method" id="sequencing_method_4" value="4">
            <label class="form-check-label" for="sequencing_method_4">
              Other (ION Torrent)
            </label>
          </div>
        </form>
        <div id="step_2_msg"></div>
      {% endif %}
    </div>

    <div id="step_3" {% if not sequencing_method %} style="opacity: 0.5;" {% endif %} class="form-step-item">
      <h3> Step 3: upload Data File (csv) </h3>
      <div class="text-danger"> Please note: This is NOT the metadata file you had been asked to create.</div>
      {% if csv_uploaded %}
        <div id="step_3_msg" class="text-success">CSV file already uploaded : <a href="/download_csv?process_id={{ process_id }}">{{ csv_filename }}</a></div>

        <div class="text-danger">If you upload the csv again it will overwrite the previous one. Only re-upload if there was something wrong</div>
      {% endif %}

        <p> <a href="/csv_structure" target="_blank" class="text-decoration-underline">Instructions for the csv file</a> </p>

        <form
            method="POST"
            action="/uploadcsv"
            class="dropzone dz-clickable"
            enctype="multipart/form-data"
            id="step_3_form"
        >
        <input type="hidden" name="sequencing_method" value="{{ sequencing_method }}">
        <input type="hidden" name="process_id" value="{{ process_id }}">
        <input type="file" id="step_3_button" accept=".csv">
        </form>
        <div id="step_3_msg"></div>

    </div>

    <div id="cvs_data">
      <h3> Records in the csv file </h3>
      <div id="cvs_table">
        <table class="table">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Sample ID</th>
              <th scope="col">Sequencer ID</th>
              <th scope="col">Sequencing Provider</th>
              <th scope="col">Project</th>
              <th scope="col">Region</th>
              <th scope="col">Index_1</th>
              <th scope="col">Index_2</th>
              <th scope="col">Matched files</th>
            </tr>
          </thead>

          <tbody id="cvs_records_body">
            {% if cvs_records %}
              {% for sample_id, data in cvs_records.items() %}
                <tr id="cvs_sample_{{ data.get('sample_id_safe', '') }}">
                    <td>{{ loop.index }}</td>
                    <td>{{ data.get('sample_id', '') }}</td>
                    <td>{{ data.get('sequencer_id', '') }}</td>
                    <td>{{ data.get('sequencer_provider', '') }}</td>
                    <td>{{ data.get('project', '') }}</td>
                    <td>{{ data.get('region', '') }}</td>
                    <td>{{ data.get('index_1', '') }}</td>
                    <td>{{ data.get('index_2', '') }}</td>
                    <td id="cvs_sample_files_{{ data.get('sample_id_safe', '') }}">
                      {% set matched_files_count = 0 %}
                      {% if matching_files_db %}
                        {% for filename, files_data in matching_files_db.items() %}
                          {% if 'csv_sample_id' in files_data %}
                            {% if filename.startswith(data['sequencer_id'].split('id', 1)[0] + 'id') %}
                              {% set matched_files_count = matched_files_count + 1 %}
                              {{ filename }} <br>
                            {% endif %}
                          {% endif %}
                        {% endfor %}
                      {% endif %}
                      {% if matched_files_count == 1 %}
                        <div class="text-danger">Only a single file matched </div>
                      {% endif %}
                    </td>
                </tr>
              {% endfor %}
            {% endif %}
          </tbody>
        </table>
      </div>
      <div id="showAllRows" class="text-info" style="cursor: pointer;">.</div>
    </div>

    <div id="step_4" {% if not csv_uploaded %} style="opacity: 0.5;" {% endif %} class="form-step-item">
      <h3> Step 4: upload gz/tar/zip file with sample data </h3>
      <form
        method="POST"
        action="/upload"
        id="step_4_form"
        enctype="multipart/form-data"
        {% if not csv_uploaded %} style="display:none;" {% endif %}
      >
        <input type="file" id="step_4_button" name="file" multiple />
        <input type="hidden" name="process_id" value="{{ process_id }}">
      </form>
      {% if csv_uploaded %}
        <div id="step_4_msg" class="text-primary">
          {% if gz_filedata %}
              {% for filename, file_data in gz_filedata.items() %}
                  {% if 'percent_uploaded' in file_data %}
                      {% if file_data.percent_uploaded == 100 %}
                          You have uploaded the file {{ filename }}<br>
                      {% else %}
                          {% if file_data.percent_uploaded > 0 %}
                              <div class="text-danger">
                                You have previously started uploading a file: {{ filename }}<br>
                                Already uploaded: {{ file_data.percent_uploaded }}%<br>
                                Please select the same file to resume uploading<br>
                                <a href="#"
                                    class="clear_file_upload btn btn-danger"
                                    data-filename="{{ filename }}"
                                    data-filename_safe="{{ filename|safe }}"
                                    data-process_id="{{ process_id }}"
                                    data-file_identifier="{{ file_data['form_fileidentifier'] }}">
                                    Or click here to clean the upload to try again the file from the beggining
                                </a>

                              </div>
                              <span style="display:none" id="file_removed-{{ file_data['form_fileidentifier'] }}">test</span>
                              <span style="display:none" id="testme2">test2</span>
                          {% endif %}
                      {% endif %}
                  {% endif %}
              {% endfor %}
          {% endif %}
        </div>
      {% else  %}
        <div id="step_4_msg"></div>
      {% endif %}
    </div>
    <div id="step_5" {% if not csv_uploaded %} style="opacity: 0.5;" {% endif %} class="form-step-item">
      <h3> Step 5: Upload raw files to google storage </h3>

      <div id="step_5_progress">
        {% if gz_filedata %}
            {% for filename, file_data in gz_filedata.items() %}
                {% if 'gz_sent_to_bucket_progress' in file_data %}
                    {% if file_data.gz_sent_to_bucket_progress == 100 %}
                        <p class="text-success">File {{ filename }} has been sent to google bucket<p>
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endif %}
      </div>
      <div id="step_5_msg"></div>

    </div>
    <div id="step_6" {% if not csv_uploaded %} style="opacity: 0.5;" {% endif %} class="form-step-item">
      <h3> Step 6: Unzip Raw files</h3>
      <div id="step_6_progress">
        {% if gz_filedata %}
            {% for filename, file_data in gz_filedata.items() %}
                {% if 'gz_unziped_progress' in file_data %}
                    {% if file_data.gz_unziped_progress == 100 %}
                        <p class="text-success">File {{ filename }} has been unzipped<p>
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endif %}
      </div>
      <div id="step_6_msg"></div>
    </div>
    <div id="step_7" class="form-step-item">
      <h3 id="step_7_title">
        Step 7:
        {% if sequencing_method and sequencing_method>1 %}
          Not Applicable to this sequencing method
        {% elif renaming_skipped and renaming_skipped==True  %}
          Renaming skipped
        {% else %}
          Rename files
        {% endif %}
      </h3>
      {% if (files_renamed) %}
        <div id="step_7_msg" class="text-success">Files renamed</div>
        <h4 id="step_7_warning" class="text-warning"></h4>
        {% if (is_admin) %}
          <button type="button" class="btn btn-secondary" id="step_7_reset_button" data-process_id="{{ process_id }}">Reset step flag</button>
        {% endif %}
      {% elif renaming_skipped and renaming_skipped==True %}
        <div id="step_7_msg" class="text-success">Renaming skipped</div>
        <h4 id="step_7_warning" class="text-warning"></h4>
        {% if (is_admin) %}
          <button type="button" class="btn btn-secondary" id="step_7_reset_button" data-process_id="{{ process_id }}">Reset step flag</button>
        {% endif %}
      {% else %}
        <h4 id="step_7_warning" class="text-warning"> ONLY start this when you have uploaded successfully all your files and the unzip process has finished for all your files</h4>
        <div>
          <form
              id="step_7_form"
              method="POST"
              action="/renamefiles"
              {% if files_renamed %} style="display: none;" {% endif %}
          >
            <input type="hidden" name="process_id" value="{{ process_id }}">
            <input type="hidden" name="skip" value="false">
            <input type="submit" class="btn btn-primary" id="step_7_button">
            {% if (is_admin) %}
              <button type="button" class="btn btn-secondary" id="step_7_skip_button">Skip renaming</button>
            {% endif %}
          </form>
        </div>
        <div id="step_7_msg"></div>
        <div id="step_7_details"></div>
      {% endif %}
    </div>
    <div id="step_8" {% if not files_renamed %} style="opacity: 0.5;" {% endif %} class="form-step-item">
      <h3 id="step_8_title">
        Step 8:
        {% if sequencing_method and sequencing_method>1 %}
          Not Applicable to this sequencing method
        {% else  %}
          Run fastqc
        {% endif %}
      </h3>

      {% if fastqc_run %}
        <div id="step_8_msg" class="text-success">Fastqc and multiqc processes run</div>
        {% if (is_admin) %}
          <button type="button" class="btn btn-secondary" id="step_8_reset_button" data-process_id="{{ process_id }}">Reset step flag</button>
        {% endif %}
      {% else %}
        <div>
          <form
              id="step_8_form"
              method="POST"
              action="/fastqcfiles"
              {% if ((not files_renamed) or (fastqc_run)) %} style="display: none;" {% endif %}
          >
            <input type="hidden" name="process_id" value="{{ process_id }}">
            <input type="submit" class="btn btn-primary" id="step_8_button">
          </form>
        </div>
        <div id="step_8_msg"></div>
        <div id="step_8_details"></div>
      {% endif %}
    </div>
    <div id="step_9" {% if not fastqc_run %} style="opacity: 0.5;" {% endif %} class="form-step-item">
      <h3 id="step_9_title">
        Step 9:
        {% if sequencing_method and sequencing_method>1 %}
          Not Applicable to this sequencing method
        {% else  %}
          Upload fastqc and multiqc files to bucket
        {% endif %}
      </h3>
      {% if fastqc_run %}
        <div id="step_9_msg" class="text-success">Multiqc report uploaded to bucket</div>
      {% else %}
        <div id="step_9_msg" class="text-success"></div>
      {% endif %}
    </div>
    <div id="step_10" {% if (not files_renamed) and (renaming_skipped and renaming_skipped==False) %} style="opacity: 0.5;" {% endif %} class="form-step-item">
      <h3 id="step_10_title">
        Step 10:
        {% if sequencing_method and sequencing_method>1 %}
          Upload fastq.gz files to project backets
        {% else  %}
          Upload renamed fastq.gz files to project backets
        {% endif %}
      </h3>
      {% if renamed_sent_to_bucket %}
        <div id="step_10_msg" class="text-success">Renamed files sent to buckets</div>
        {% if (is_admin) %}
          <button type="button" class="btn btn-secondary" id="step_10_reset_button" data-process_id="{{ process_id }}">Reset step flag</button>
        {% endif %}
      {% else %}
        <div>
          <form
              id="step_10_form"
              method="POST"
              action="/uploadfinalfiles"
          >
            <input type="hidden" name="process_id" value="{{ process_id }}">
            <input type="submit" class="btn btn-primary" id="step_10_button">
          </form>
        </div>
        <div id="step_10_msg"></div>
      {% endif %}
    </div>


    <h3> Unzipped files</h3>
    <div id="files_table">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Original filename</th>
            <th scope="col">Renamed to</th>
            <th scope="col">Bucket</th>
            <th scope="col">Folder</th>
            <th scope="col">Moved to bucket</th>
            <th scope="col">MultiQC report</th>
          </tr>
        </thead>
        <tbody id="files_body">
          {% if matching_files_db %}

            {% set rowspan_counts = {} %}
            {% for filename, data in matching_files_db.items() %}
              {% set rowspan = data.get('rowspan', 0) %}
              <tr>
                  <th scope="row">{{ loop.index }}</th>
                  <td>{{ filename }}</td>
                  <td>{{ data.get('new_filename', '') }}</td>
                  <td>{{ data.get('bucket', '') }}</td>
                  <td>{{ data.get('folder', '') }}</td>
                  <td>{{ data.get('uploaded', '') }}</td>
                  {% if fastqc_run %}
                    {% if rowspan > 1 %}
                      <td rowspan="{{ rowspan }}">
                          <a href="/multiqc?process_id={{ process_id }}&bucket={{ data.get('bucket', '') }}&folder={{ data.get('folder', '') }}" target="_blank">Open multiqc report</a>
                      </td>
                    {% endif %}
                  {% else %}
                    <td></td>
                  {% endif %}
              </tr>
              {% if rowspan > 1 %}
                {% set _ = rowspan_counts.update({key: rowspan - 1}) %}
              {% endif %}
            {% endfor %}
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
    <script type="application/javascript">
        let process_id = {{ process_id | default('0') }}; // To track the process from start to end.
        let sequencing_method = {{ sequencing_method if sequencing_method else 0 }};
        let gz_filedata = {{ gz_filedata|tojson if gz_filedata else '{}' }};
        let matching_files_db = {{ matching_files_db|tojson if matching_files_db else '{}' }};
        let files_renamed = {{ 1 if files_renamed else 0 }};
        let renaming_skipped = {{ 1 if renaming_skipped else 0 }};


        function redrawCsvTable(cvs_records) {
          var tableBody = $('#cvs_records_body');
          tableBody.empty();

          if (cvs_records) {
            $.each(cvs_records, function(sample_id, data) {
              var newRow = $('<tr>').attr('id', 'cvs_sample_' + data.sample_id_safe);
              newRow.append(
                $('<td>').text(tableBody.children().length + 1),
                $('<td>').text(data.sample_id),
                $('<td>').text(data.sequencer_id),
                $('<td>').text(data.sequencer_provider),
                $('<td>').text(data.project),
                $('<td>').text(data.region),
                $('<td>').text(data.index_1),
                $('<td>').text(data.index_2),
                $('<td>').attr('id', 'cvs_sample_files_' + data.sample_id_safe)
              );
              tableBody.append(newRow);
            });
          }
          cvsRowsHide();
        }

        function updateCsvTable(matching_files_db) {
          $('#cvs_records_body tr').each(function() {
            var sequencerId = $(this).find('td:eq(2)').text().trim();
            var lastTd = $(this).find('td:last');
            lastTd.empty();

            var matchedFilesCount = 0;

            if (matching_files_db) {
              $.each(matching_files_db, function(filename, filesData) {
                var sequencerIdPrefix = sequencerId.split('_S')[0]; // Extracting prefix before "_S"
                var filenamePrefix = filename.split('_S')[0]; // Extracting prefix before "_S"
                if (filename.startsWith(sequencerIdPrefix)) {
                  lastTd.append(filename + '<br>');
                  matchedFilesCount++;
                }
              });
            }

            if (matchedFilesCount === 1) {
              lastTd.append('<div class="text-danger">Only a single file matched </div>');
            }
          });
        }


        function reorderByBucketFolderAndRowspan(originalObject) {
          // Extract keys and sort based on bucket, folder, and rowspan
          const sortedKeys = Object.keys(originalObject).sort((a, b) => {
            // Check if bucket key exists in both objects
            const bucketA = originalObject[a].bucket || '';
            const bucketB = originalObject[b].bucket || '';

            // Compare buckets
            const bucketComparison = bucketA.localeCompare(bucketB);
            if (bucketComparison !== 0) {
              return bucketComparison;
            }

            // Check if folder key exists in both objects
            const folderA = originalObject[a].folder || '';
            const folderB = originalObject[b].folder || '';

            // Compare folders
            const folderComparison = folderA.localeCompare(folderB);
            if (folderComparison !== 0) {
              return folderComparison;
            }

            // Check if rowspan key exists in both objects
            const rowspanA = originalObject[a].rowspan || 0;
            const rowspanB = originalObject[b].rowspan || 0;

            // Compare rowspan, prioritize rows with rowspan
            if (rowspanA !== rowspanB) {
              return rowspanB - rowspanA;
            }

            return 0; // If everything is equal, maintain current order
          });

          // Reconstruct the object with sorted keys
          const sortedObject = sortedKeys.reduce((acc, key) => {
            acc[key] = originalObject[key];
            return acc;
          }, {});

          return sortedObject;
        }

        // Function to redraw the HTML table based on the updated dictionary
        function redrawTable(filesDict) {
            var filesDict = reorderByBucketFolderAndRowspan(filesDict);
            var tableBody = $('#files_body');
            tableBody.empty(); // Clear existing table rows

            // Iterate over the dictionary to populate the table and calculate rowspan counts
            $.each(filesDict, function(oldFilename, fileDetails) {
                var newRow = '<tr>' +
                                '<th scope="row">' + '</th>' +
                                '<td>' + oldFilename + '</td>' +
                                '<td>' + (fileDetails.new_filename || '') + '</td>' +
                                '<td>' + (fileDetails.bucket || '') + '</td>' +
                                '<td>' + (fileDetails.folder || '') + '</td>' +
                                '<td>' + (fileDetails.uploaded || '') + '</td>';

                if (fileDetails.rowspan > 1) {
                  newRow +=         '<td rowspan="' + (fileDetails.rowspan) + '">';
                  newRow +=         '<a href="/multiqc?process_id=' + process_id + '&bucket=' + (fileDetails.bucket || '') + '&folder=' + (fileDetails.folder || '') + '" target="_blank">Open multiqc report</a>';
                  newRow +=         '</td>';
                }
                newRow +=      '</tr>';

                tableBody.append(newRow);
            });

            // Update the row numbers in the first column
            tableBody.find('tr').each(function(index) {
                $(this).find('th').text(index + 1);
            });
            updateCsvTable(filesDict);
        }

        function cvsRowsHide() {
          // Define the number of rows to show
          let cvs_rows_show = 10;
          var totalRows = $('#cvs_records_body tr').length;

          // Hide all rows after the specified number of rows
          $('#cvs_records_body tr:gt(' + (cvs_rows_show - 1) + ')').hide();

          // Check if excess rows are visible after toggling
          var excessRowsVisible = $('#cvs_records_body tr:gt(' + (cvs_rows_show - 1) + ')').is(':visible');
          if (totalRows > cvs_rows_show) {
            $('#showAllRows').text(excessRowsVisible ? 'hide excess rows' : 'only ' + cvs_rows_show + ' rows shown, click here to see them all');
          }
        }

        function cvsRowsToggle() {
          // Define the number of rows to show
          let cvs_rows_show = 10;

          // Add a click event handler to the "+" symbol
          $('#showAllRows').click(function() {
            // Toggle visibility of all rows after the specified number of rows
            $('#cvs_records_body tr:gt(' + (cvs_rows_show - 1) + ')').toggle();

            // Check if excess rows are visible after toggling
            var excessRowsVisible = $('#cvs_records_body tr:gt(' + (cvs_rows_show - 1) + ')').is(':visible');

            // Change the text of the "+" symbol based on the visibility of excess rows
            $('#showAllRows').text(excessRowsVisible ? 'hide excess rows' : 'only ' + cvs_rows_show + ' rows shown, click here to see them all');
          });
        }

        $(document).ready(function() {
          $('.clear_file_upload').on('click', function() {
            event.preventDefault();
            var filename = $(this).data('filename');
            var file_identifier = $(this).data('file_identifier');
            var this_process_id = $(this).data('process_id');


            // Make AJAX request to remove access to the bucket
            $.ajax({
              url: '/clear_file_upload',
              type: 'POST',
              data: {
                filename: filename,
                process_id: this_process_id
              },
              success: function(response) {
                // Handle success response if needed
                console.log('Cleaned upload of :', filename);
                if (response.status==1) {
                  var span_id = '#file_removed-'+file_identifier;
                  $(span_id).show().html('File upload cleaned. Please retry the file');
                }
              },
              error: function(xhr, status, error) {
                // Handle error response if needed
                console.error('Error cleaning upload:', error);
              }
            });
          });
        });

        // Handle the step_3 (Sequencing method selection)
        $(document).ready(function() {

          // Function to handle radio button change event
          $('input[name="sequencing_method"]').change(function() {
            sequencing_method = parseInt($(this).val());
            var form3 = $("#step_3_form");
            form3.find('input[name="sequencing_method"]').val(sequencing_method);
            $('#step_3').css('opacity', '1');
            $('#step_3_form').show();
            console.log("Selected sequencing method 1: ", sequencing_method);
            $('input[name="sequencing_method"]').not(this).prop('disabled', true);
            if (sequencing_method>1) {
              $('#step_7_title').html('Step 6: Not Applicable to this sequencing method');
              $('#step_8_title').html('Step 7: Not Applicable to this sequencing method');
              $('#step_9_title').html('Step 8: Not Applicable to this sequencing method');
              $('#step_10_title').html('Step 9: Upload fastq.gz files to project backets');
            }
          });
        });

        $(document).ready(function() {
          cvsRowsHide();
          cvsRowsToggle();
        });


        $(document).ready(function () {
          redrawTable(matching_files_db);
          if ((files_renamed==0) && (renaming_skipped==0)) {
            $('#step_10_form').hide();
          }

        });

        function hide_form_7() {
          $('#step_7_button').hide();
          $('#step_7_skip_button').hide();
          $('#step_7_warning').hide();
          $('#step_7').css('opacity', '0.5');
        }

        function show_form_7() {
          $('#step_7_button').show();
          $('#step_7_skip_button').show();
          $('#step_7_warning').show();
          $('#step_7').css('opacity', '1');
        }

        $(document).ready(function () {
          if (!gz_filedata || Object.keys(gz_filedata).length === 0 || sequencing_method==0 || sequencing_method>1) {
            hide_form_7();
          }

          if (!areAllFilesMatchedToBuckets(matching_files_db)) {
            console.log('Not all files are matched');
            console.log(matching_files_db);
            hide_form_7();
          }

          if (sequencing_method>1 && gz_filedata && Object.keys(gz_filedata).length > 0) {
            $('#step_10_form').show();
            $('#step_10').css('opacity', '1');
          }

        });

        function calculateMD5(file, callback, updateCallback) {
            var chunkSize = 2097152; // 2 MB chunks
            var spark = new SparkMD5.ArrayBuffer();
            var fileReader = new FileReader();
            var startTime = performance.now(); // Start timer
            var totalChunks = Math.ceil(file.size / chunkSize);
            var chunksProcessed = 0;

            fileReader.onload = function (event) {
                spark.append(event.target.result); // Append chunk to MD5 calculation
                chunksProcessed++;
                if (chunksProcessed < totalChunks) {
                    loadNext();
                } else {
                    var endTime = performance.now(); // End timer
                    var duration = endTime - startTime; // Calculate duration
                    console.log('MD5 calculated in ' + duration.toFixed(2) + ' milliseconds'); // Log duration
                    callback(spark.end());
                }
                updateCallback((chunksProcessed / totalChunks) * 100); // Update progress
            };

            fileReader.onerror = function () {
                console.warn('Error reading file');
                callback(null);
            };

            function loadNext() {
                var start = fileReader.loaded || 0;
                var end = Math.min(start + chunkSize, file.size);
                fileReader.readAsArrayBuffer(file.slice(start, end));
                fileReader.loaded = end; // Update loaded bytes
            }

            loadNext();
        }

        $(document).ready(function () {
            $('#step_1_button').on('change', function () {
                uploadMetadataFile();
            });
        });

        $(document).ready(function () {
            $('#step_3_button').on('change', function () {
                uploadCsvFile();
            });
        });

        function uploadMetadataFile() {
          var fileInput = $('#step_1_button')[0];
          var file = fileInput.files[0];

          if (!file) {
              alert("Please select a file.");
              return;
          }

          var formData = new FormData();
          formData.append('file', file);

          $.ajax({
              url: '/uploadmetadata',
              type: 'POST',
              data: formData,
              contentType: false,
              processData: false,
              success: function (response) {
                  // Access and use the process ID
                  process_id = response.process_id;
                  upload_folder = response.upload_folder;

                  // Update the hidden input field within the specific forms
                  var form3 = $("#step_3_form");
                  form3.find('input[name="process_id"]').val(process_id);
                  var form4 = $("#step_4_form");
                  form4.find('input[name="process_id"]').val(process_id);
                  var form7 = $("#step_7_form");
                  form7.find('input[name="process_id"]').val(process_id);
                  var form8 = $("#step_8_form");
                  form8.find('input[name="process_id"]').val(process_id);
                  var form10 = $("#step_10_form");
                  form10.find('input[name="process_id"]').val(process_id);
                  $('#process_id_info').html('Process ID: ' + process_id);
                  $('#upload_folder_info').html('Folder: ' + upload_folder)

                  $('#step_1_msg').html(response.msg).removeClass('text-danger').addClass('text-success');
                  $('#step_1_button').prop('disabled', true);

                  $('#step_2').css('opacity', '1');
                  $('#step_2_form').show();
              },
              error: function (xhr) {
                if (xhr && xhr.responseText) {
                    var response = JSON.parse(xhr.responseText);
                    $("#step_1_msg").html(response.error + ' ' + response.results).addClass('text-danger').removeClass('text-info').removeClass('text-success');
                } else {
                    $("#step_1_msg").html(errorMessage).addClass('text-danger').removeClass('text-info').removeClass('text-success');
                }
              }
          });
        }

        function uploadCsvFile() {
          var fileInput = $('#step_3_button')[0];
          var file = fileInput.files[0];

          if (!file) {
              alert("Please select a file.");
              return;
          }

          var formData = new FormData();
          formData.append('file', file);
          formData.append('process_id', process_id);
          console.log('715 in uploadCsvFile process_id  is ' + process_id)

          //var sequencing_method = $('#step_3_form input[name="sequencing_method"]').val();
          console.log('in uploadCsvFile sequencing method is ' + sequencing_method)
          formData.append('sequencing_method', sequencing_method);

          $.ajax({
              url: '/uploadcsv',
              type: 'POST',
              data: formData,
              contentType: false,
              processData: false,
              success: function (response) {
                  // Access and use the process ID
                  upload_folder = response.upload_folder;

                  redrawCsvTable(response.cvs_records)

                  matching_files_db = response.matching_files_db;
                  updateCsvTable(matching_files_db)

                  $('#step_3_msg').html(response.msg).removeClass('text-danger').addClass('text-success');
                  $('#step_3_button').prop('disabled', true);

                  $('#step_4').css('opacity', '1');
                  $('#step_4_form').show();
                  $('#step_4_button').prop('disabled', false);
                  $('#step_5').css('opacity', '1');
                  $('#step_6').css('opacity', '1');
              },
              error: function (xhr) {
                if (xhr && xhr.responseText) {
                    var response = JSON.parse(xhr.responseText);
                    $("#step_3_msg").html(response.error + ' ' + response.results).addClass('text-danger').removeClass('text-info').removeClass('text-success');
                } else {
                    $("#step_3_msg").html(errorMessage).addClass('text-danger').removeClass('text-info').removeClass('text-success');
                }
              }
          });
        }

        // Initialize Resumable.js
        var allowedExtensions = ['gz', 'tar', 'zip']; // Define allowed file extensions
        var commonOptions = {
            target: '/upload',
            chunkSize: 10 * 1024 * 1024,
            testChunks: true,
            uploadMethod: 'POST',
            fileType: allowedExtensions,
            fileTypeErrorCallback: function(file, errorCount) {
                // Check if the file extension is allowed
                var fileExtension = file.name.split('.').pop().toLowerCase();
                if (!allowedExtensions.includes(fileExtension)) {
                    alert('File type not allowed! Please select a .gz, .tar, or .zip file.');
                    return false; // Cancel the file upload
                }
            },
        };
        var uploading = false;
        // Initialize Resumable.js with common options
        var r = new Resumable(commonOptions);

        // Event listener for when files are added
        r.on('filesAdded', function(files) {
            var file_index = 0;
            hide_form_7();
            files.forEach(function(file) {
                file_index = file_index +1;
                // Handle each file individually
                console.log('file added to resumable:', file);
                console.log('Unique Identifier for file:', file.uniqueIdentifier);

                var file_msg_id = 'step_4_file_' + file.uniqueIdentifier;
                var file_name = file.file.name;
                var file_row = '<div id="' + file_msg_id + '">Calculating md5 for: ' + file_name + '</div>';
                $('#step_4_msg').append( file_row );

                //Add lines for third step
                var step_5_msg_id = 'step_5_file_' + file.uniqueIdentifier;
                var step_5_file_row = '<div id="' + step_5_msg_id + '"></div>';
                $('#step_5_progress').append( step_5_file_row );

                //Add lines for fourth step
                var step_6_msg_id = 'step_6_file_' + file.uniqueIdentifier;
                var step_6_file_row = '<div id="' + step_6_msg_id + '"></div>';
                $('#step_6_progress').append( step_6_file_row );
                console.log('In /upload on line 799 the process_id is ' + process_id)
                // Customize options for each file
                var fileOptions = {
                    query: {
                        process_id: process_id,
                        filename: file.file.name,
                        filesize: file.file.size,
                        filechunks: Math.ceil(file.file.size / r.opts.chunkSize),
                        fileindex: file.uniqueIdentifier
                    },
                };

                // Create a new Resumable instance for each file with merged options
                var resumableFile = new Resumable(Object.assign({}, commonOptions, fileOptions));

                // Assign the current file to the Resumable instance
                resumableFile.addFile(file.file);

                // Listen to events for each file
                resumableFile.on('progress', function(file) {
                  let progress =Math.round(resumableFile.progress() * 10000)/100
                  var file_msg_id = 'step_4_file_' + resumableFile.files[0].uniqueIdentifier;
                  $("#" + file_msg_id).html('Upload progress: ' + progress.toFixed(2) + '%');
                  if (progress < 100) {
                    uploading = true;
                  }
                });

                resumableFile.on('fileSuccess', function(file, message) {
                  const parsedMessage = JSON.parse(message);
                  gz_filedata = parsedMessage.gz_filedata;
                  var file_id = resumableFile.files[0].uniqueIdentifier;
                  var file_msg_id = 'step_4_file_' + file_id;
                  var file_name = file.file.name;
                  $("#" + file_msg_id).html('Upload of file ' + file_name + ' finished').addClass('text-success').removeClass('text-danger').removeClass('text-info');

                  // We automatically will start step 4 on the server, so lets start getting updates
                  updateProgressRawFileBucket(process_id, file_id, file_name);
                  // We automatically will start step 5 on the server, so lets start getting updates
                  updateProgressUnZip(process_id, file_id, file_name);
                  uploading = false;
                });

                // Assign file input to the Resumable instance
                resumableFile.assignBrowse(document.getElementById('step_4_button'));

                // Start upload for each file
                setTimeout(function() {
                  calculateMD5(file.file,
                      function (md5) {
                          resumableFile.opts.query.md5 = md5; // Add MD5 hash to the query parameters
                          $("#" + file_msg_id).html('Md5 for file ' + file_name + ' calculated:' + md5).addClass('text-info').removeClass('text-danger').removeClass('text-success');

                          // Enable the button after calculation is completed
                          $('#step_4_button').prop("disabled", false);

                          resumableFile.upload();

                      },
                      function (progress) {
                        if (progress<100) {
                          $("#" + file_msg_id).html('Calculating md5 for file ' + file_name + '. Progress: ' + progress.toFixed(2) + '%').addClass('text-info').removeClass('text-danger').removeClass('text-success');
                        }
                      }
                  );
                }, (file_index* 500));
            });
        });

        // Assign file input to the main Resumable instance
        r.assignBrowse(document.getElementById('step_4_button'));

        let intervals = {}; // To store interval IDs for each file upload

        function updateProgressRawFileBucket(process_id, file_id, file_name) {
            console.log('We will now start calling for updates for ProgressRawFileBucket for file id ' + file_id);

            let interval_id = 'rawtobucket_' + process_id + '_' + file_id;
            // Clear any existing interval for the same file upload
            clearInterval(intervals[interval_id]);

            intervals[interval_id] = setInterval(function () {
                $.ajax({
                    url: `/uploadprogress?process_id=${process_id}&file_id=${file_id}`,
                    type: 'GET',
                    success: function(data) {
                        let progress = data.progress;
                        gz_filedata = data.gz_filedata;

                        var step_5_msg_id = 'step_5_file_' + file_id;
                        // Check if the element with id step_5_msg_id exists

                        if ($('#' + step_5_msg_id).length === 0) {
                            // If it doesn't exist, create it
                            var step_5_file_row = $('<div id="' + step_5_msg_id + '"></div>');
                            // Append it to the parent element with id step_5_progress
                            $('#step_5_progress').append(step_5_file_row);
                        }
                        $('#'+step_5_msg_id).text(`Bucket Transfer Progress of file ${file_name}: ${progress}%`);

                        if (progress >= 100) {
                            $('#'+step_5_msg_id).addClass('text-success').removeClass('text-info');
                            clearInterval(intervals[interval_id]); // Stop updating when progress reaches 100%
                            console.log('We will now stop calling for updates in updateProgressRawFileBucket');

                        }
                    },
                    error: function() {
                        // Handle error situations
                    }
                });
            }, 5000); // Update progress every 5 seconds (adjust timing as needed)
        }

        function updateProgressAllRawFilesBucket(process_id) {
            // Get all the filenames for this process_id
            let filenames = Object.keys(gz_filedata);

            // Iterate over each filename
            filenames.forEach(filename => {
                let fileData = gz_filedata[filename];

                // Check if the fileData object has the key gz_sent_to_bucket_progress
                if (fileData.hasOwnProperty('gz_sent_to_bucket_progress')) {
                    // Check if the progress is >0 and <100
                    if (fileData.gz_sent_to_bucket_progress > 0 && fileData.gz_sent_to_bucket_progress < 100) {
                        // Call updateProgressRawFileBucket function
                        updateProgressRawFileBucket(process_id, fileData.form_fileidentifier, fileData.form_filename);
                    }
                }
            });
        }

        updateProgressAllRawFilesBucket(process_id);

        function areAllFilesUnzipped(gz_filedata) {
            // Iterate over each filename and its corresponding data
            for (const filename in gz_filedata) {
                if (gz_filedata.hasOwnProperty(filename)) {
                    const fileData = gz_filedata[filename];
                    // Check if gz_unziped_progress is not equal to 100
                    if (fileData.gz_unziped_progress !== 100) {
                        // If any file is not unzipped, return false
                        return false;
                    }
                }
            }
            // If all files are unzipped, return true
            return true;
        }

        function areAllFilesMatchedToBuckets(filesDict) {
            for (const filename in filesDict) {
                const fileInfo = filesDict[filename];
                if (!fileInfo.bucket || !fileInfo.folder) {
                    return false;
                }
            }
            return true;
        }


        function updateProgressUnZip(process_id, file_id, file_name) {
            console.log('We will now start calling for updates for ProgressUnZip for file ' + file_name);

            let interval_id = 'unzip_' + process_id + '_' + file_id;
            // Clear any existing interval for the same file upload
            clearInterval(intervals[interval_id]);

            intervals[interval_id] = setInterval(function () {
                $.ajax({
                    url: `/unzipprogress?process_id=${process_id}&file_id=${file_id}`,
                    type: 'GET',
                    success: function(data) {
                        let progress = data.progress;
                        gz_filedata = data.gz_filedata;
                        var step_6_msg_id = 'step_6_file_' + file_id;
                        // Check if the element with id step_5_msg_id exists

                        if ($('#' + step_6_msg_id).length === 0) {
                            // If it doesn't exist, create it
                            var step_6_file_row = $('<div id="' + step_6_msg_id + '"></div>');
                            // Append it to the parent element with id step_6_progress
                            $('#step_6_progress').append(step_5_file_row);
                        }
                        $('#'+step_6_msg_id).text(`Unzip Progress of file ${file_name}: ${progress}%`);


                        if (progress >= 100) {
                            clearInterval(intervals[interval_id]); // Stop updating when progress reaches 100%
                            console.log('We will now stop calling for updates for ProgressUnZip for file ' + file_name);
                            $('#'+step_6_msg_id).text(`File ${file_name}: ${progress}% successfully unziped`).addClass('text-success').removeClass('text-info');

                            let filesDict = data.files_dict_db;
                            redrawTable(filesDict);

                            if (areAllFilesMatchedToBuckets(filesDict)) {
                              // We should check if all available files have been uzipped
                              // and if yes, we should enable the next step
                              if (areAllFilesUnzipped(gz_filedata)) {
                                if (!uploading) {
                                  // HERE
                                  if (sequencing_method==1) {
                                    show_form_7();
                                  } else {
                                    hide_form_7();
                                    $('#step_10_form').show();
                                    $('#step_10').css('opacity', '1');
                                  }
                                }
                              } else {
                                hide_form_7();
                              }
                            } else {
                              $('#step_7_msg').text('Not all files are matched to records in your CSV. Please correct this by either renaming your files, or fixing your CSV. Please check the table bellow to see which files are not matched.').removeClass('text-success').addClass('text-danger');;
                              hide_form_7();
                            }

                        }
                    },
                    error: function() {
                        // Handle error situations
                    }
                });
            }, 10000); // Update progress every 10 seconds (adjust timing as needed)
        }

        $(document).ready(function () {
            $('#step_7_form').submit(function (event) {
                // Prevent the default form submission
                event.preventDefault();
                $('#step_7_button').prop("disabled", true);
                $('#step_7_skip_button').prop("disabled", true);
                $('#step_7_warning').hide();
                // Get form data
                var formData = $(this).serialize();
                var skipValue = $('input[name="skip"]').val();

                $.ajax({
                    type: 'POST',
                    url: '/renamefiles',
                    data: formData,
                    success: function (response) {
                        // Handle success
                        console.log(response)
                        console.log('Form data submitted via AJAX successfully');

                        $('#step_7_msg').text(response.msg).addClass('text-success');

                        console.log(response.skipped)
                        if (!skipValue) {
                          let results = response.results;
                          let filesDict = response.files_dict;
                          // Redraw the HTML table
                          redrawTable(filesDict);
                        }

                        $('#step_7_button').hide();
                        $('#step_7_skip_button').hide();
                        $('#step_8_form').show();
                        $('#step_8').css('opacity', '1');
                        $("#step_8_form").submit();

                        $('#step_10_form').show();
                        $('#step_10').css('opacity', '1');

                    },
                    error: function (error) {
                        // Handle errors
                        console.error('Error submitting form data via AJAX', error);
                    }
                });
            });
            // Event handler for skip button
            $('#step_7_skip_button').click(function () {
                // Disable rename button
                $('#step_7_button').prop("disabled", true);
                // Submit form with skip flag
                $('input[name="skip"]').val("true");
                $('#step_7_form').submit();
            });
        });


        function updateProgressMultiqc(process_id) {
            console.log('We will now start calling for updates for fastqc');

            let interval_id = 'fastq_' + process_id
            // Clear any existing interval for the same file upload
            clearInterval(intervals[interval_id]);

            intervals[interval_id] = setInterval(function () {
                $.ajax({
                    url: `/fastqcprogress?process_id=${process_id}`,
                    type: 'GET',
                    success: function(data) {
                        let process_finished = data.process_finished;
                        let filesDict = data.files_dict_db;

                        if (process_finished == 1) {
                            clearInterval(intervals[interval_id]); // Stop updating when progress reaches 100%
                            redrawTable(filesDict);
                            console.log('We will now stop calling for updates');
                            $('#step_8_msg').text('Creation of fastqc and multiqc reports finished').addClass('text-success').removeClass('text-info');
                            $('#step_8_button').hide();
                            $('#step_9').css('opacity', '1');
                            $('#step_9_msg').text('Fastqc and multiqc files transfered to bucket');
                        } else {
                            if (data.progress_text === null || data.progress_text === '') {
                              $('#step_8_msg').text('Fastqc and multiqc process started').addClass('text-info').removeClass('text-success');
                            } else {
                              $('#step_8_msg').text(data.progress_text).addClass('text-info').removeClass('text-success');
                            }
                        }
                    },
                    error: function() {
                        // Handle error situations
                    }
                });
            }, 3000); // Update progress every 5 seconds (adjust timing as needed)
        }

        function updateProgressRenamedToBucket(process_id) {
            console.log('We will now start calling for updates for moving renamed files to bucket');

            let interval_id = 'moverenamed_' + process_id
            // Clear any existing interval for the same file upload
            clearInterval(intervals[interval_id]);

            intervals[interval_id] = setInterval(function () {
                $.ajax({
                    url: `/movefinaldprogress?process_id=${process_id}`,
                    type: 'GET',
                    success: function(data) {
                        let process_finished = data.process_finished;
                        if (process_finished == 1) {
                            clearInterval(intervals[interval_id]); // Stop updating when progress reaches 100%
                            console.log('We will now stop calling for updates for final files to bucket');
                            $('#step_10_msg').text('All final files moved to project buckets').addClass('text-success').removeClass('text-info');
                        } else {
                            $('#step_10_msg').text('Files done: ' + data.files_done + ' / ' +  data.files_main).addClass('text-info').removeClass('text-success');
                        }
                        $.each(data.files_dict, function(oldFilename, fileDetails) {
                            // Iterate through table rows in the tbody with ID 'files_body'
                            $('#files_body tr').each(function() {
                                var currentFilename = $(this).find('td:nth-child(2)').text(); // Get the filename from the second cell
                                if (currentFilename === oldFilename) {
                                    // Update the third cell with new_filename if it exists in fileDetails
                                    if ('uploaded' in fileDetails) {
                                        $(this).find('td:nth-child(6)').text(fileDetails.uploaded);
                                    }
                                }
                            });
                        });
                    },
                    error: function() {
                        // Handle error situations
                    }
                });
            }, 5000); // Update progress every 5 seconds (adjust timing as needed)
        }

        $(document).ready(function () {
            $('#step_8_form').submit(function (event) {
                // Prevent the default form submission
                event.preventDefault();
                $('#step_8_button').prop("disabled", true);
                $('#step_4_form').hide();

                // Get form data
                var formData = $(this).serialize();
                var process_id = $(this).find('input[name="process_id"]').val();
                updateProgressMultiqc(process_id)

                $.ajax({
                    type: 'POST',
                    url: '/fastqcfiles',
                    data: formData,
                    success: function (response) {
                        // Handle success
                        console.log('Form data submitted via AJAX successfully');

                        $('#step_8_msg').text('Fastqc process started').addClass('text-info');
                    },
                    error: function (error) {
                        // Handle errors
                        console.error('Error submitting form data via AJAX', error);
                    }
                });
            });
        });

        $(document).ready(function () {
            $('#step_10_form').submit(function (event) {
                // Prevent the default form submission
                event.preventDefault();
                $('#step_10_button').prop("disabled", true);
                // Get form data
                var formData = $(this).serialize();
                var process_id = $(this).find('input[name="process_id"]').val();
                updateProgressRenamedToBucket(process_id)
                console.log(formData);

                $.ajax({
                    type: 'POST',
                    url: '/uploadfinalfiles',
                    data: formData,
                    success: function (response) {
                        // Handle success
                        console.log('Form data for upload files submitted via AJAX successfully');

                        $('#step_10_msg').text('Upload files process started').addClass('text-info');
                    },
                    error: function (error) {
                        // Handle errors
                        console.error('Error submitting form data via AJAX', error);
                    }
                });
            });

            $('#step_10_reset_button').click(function() {
              // Toggle visibility of all rows after the specified number of rows
              var this_process_id = $(this).data('process_id');
              $.ajax({
                  type: 'POST',
                  url: '/reset_flag',
                  data: {
                    flag: 'final_files_sent_to_bucket',
                    process_id: this_process_id
                  },
                  success: function (response) {
                      // Handle success
                      console.log('Reset flag submitted via AJAX successfully');
                  },
                  error: function (error) {
                      // Handle errors
                      console.error('Error submitting form data via AJAX', error);
                  }
              });
            });

            $('#step_7_reset_button').click(function() {
              // Toggle visibility of all rows after the specified number of rows
              var this_process_id = $(this).data('process_id');
              $.ajax({
                  type: 'POST',
                  url: '/reset_flag',
                  data: {
                    flag: 'renaming_files',
                    process_id: this_process_id
                  },
                  success: function (response) {
                      // Handle success
                      console.log('Reset flag submitted via AJAX successfully');
                  },
                  error: function (error) {
                      // Handle errors
                      console.error('Error submitting form data via AJAX', error);
                  }
              });
            });

            $('#step_8_reset_button').click(function() {
              // Toggle visibility of all rows after the specified number of rows
              var this_process_id = $(this).data('process_id');
              $.ajax({
                  type: 'POST',
                  url: '/reset_flag',
                  data: {
                    flag: 'fastqc',
                    process_id: this_process_id
                  },
                  success: function (response) {
                      // Handle success
                      console.log('Reset flag submitted via AJAX successfully');
                  },
                  error: function (error) {
                      // Handle errors
                      console.error('Error submitting form data via AJAX', error);
                  }
              });
            });

        });
    </script>
</body>
</html>
